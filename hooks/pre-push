#!/usr/bin/env bash
# Pre-push hook to run the CI/CD simulation pipeline.
# Make this executable: chmod +x .git/hooks/pre-push

set -e

echo "ðŸš€ Starting pre-push CI/CD simulation..."

# 1. AI Code Review Stage
echo "ðŸ”¬ Running AI Code Review..."
DIFF=$(git diff --staged)
PAYLOAD=$(jq -n --arg diff "$DIFF" '{"diff": $diff}')

ANALYSIS_RESULT=$(curl -s -X POST http://localhost:3001/analyze -H "Content-Type: application/json" -d "$PAYLOAD")

if [ -z "$ANALYSIS_RESULT" ]; then
  echo "âŒ Error: Analysis server did not respond." >&2
  exit 1
fi

ANALYSIS_STATUS=$(echo "$ANALYSIS_RESULT" | jq -r '.overallStatus')

if [ "$ANALYSIS_STATUS" == "FAIL" ]; then
  echo "âŒ AI Code Review Failed. Push aborted." >&2
  echo "$ANALYSIS_RESULT" | jq
  exit 1
else
  echo "âœ… AI Code Review Passed."
fi

# 2. Containerized Tests Stage
echo "ðŸ§ª Running Containerized Tests..."
TEST_RESULT=$(curl -s -X POST http://localhost:3001/test)

if [ -z "$TEST_RESULT" ]; then
  echo "âŒ Error: Test server did not respond." >&2
  exit 1
fi

TEST_SUCCESS=$(echo "$TEST_RESULT" | jq -r '.success')

if [ "$TEST_SUCCESS" != "true" ]; then
  echo "âŒ Containerized Tests Failed. Push aborted." >&2
  echo "$TEST_RESULT" | jq
  exit 1
else
  echo "âœ… Containerized Tests Passed."
fi

echo "ðŸŽ‰ All checks passed. Proceeding with push."
exit 0
